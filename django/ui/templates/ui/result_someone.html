{% extends 'ui/base.html' %}
{% load static %}

{% block content %}
<!-- 보안을 위한 CSRF 토큰 및 필수 외부 리소스 -->
<input type="hidden" id="csrf_token" value="{{ csrf_token }}">
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<link rel="stylesheet" type="text/css" href="{% static 'ui/style.css' %}?v=3.0">

<div class="result-container">
    <!-- 1. 헤더 섹션 (result.txt 스타일 적용) -->
    <div class="result-header" style="text-align: center; margin-top: 40px; margin-bottom: 60px;">
        <h1 class="page-title" style="text-align: center; padding: 0;">My Perfume</h1>
        <p class="page-subtitle" style="text-align: center; color: #888; margin-bottom: 10px;">그 사람의 향을 찾으세요</p>
        <h2 class="section-header">For Someone, 그 사람의 분위기를 향기로 담아 선물하면 어떨까?</h2>
    </div>

    <!-- 2. 상단 분석 영역 (result.txt의 가로 배치 레이아웃 적용) -->
    <div class="analysis-horizontal-box">
        <!-- [좌측] 사용자가 선택한 코디 이미지 -->
        <div class="clothing-img-box" id="outfit-display-area">
            <span class="material-icons" style="font-size: 60px; color: #ddd;">checkroom</span>
            <p style="font-size: 14px; color: #999;">코디를 불러오는 중...</p>
        </div>

        <!-- [우측] AI 분석 결과 -->
        <div class="llm-explanation-box">
            <h3>분석 결과 및 추천 이유</h3>
            <p id="ai-summary-text" style="line-height: 1.6; color: #555;">
                AI가 선택하신 코디와 정보를 분석하여 추천 이유를 작성하고 있습니다. 잠시만 기다려 주세요...
            </p>
        </div>
    </div>

    <!-- 3. 하단 향수 그리드 (result.txt의 동적 그리드 적용) -->
    <div class="perfume-grid-container">
        <h3 class="grid-title">TOP3 Quick Pick <span class="material-icons" style="vertical-align: middle; font-size: 18px;">arrow_forward</span></h3>
        <div class="perfume-cards-wrapper" id="perfume-results-container">
            <!-- 자바스크립트가 카드들을 여기에 생성합니다 -->
        </div>
    </div>

    <!-- 4. Gift Card Message (For Someone 전용 섹션 유지) -->
    <div class="gift-section" style="margin-top: 80px; padding-top: 40px; border-top: 1px solid #eee;">
        <h2 class="gift-header" style="font-size: 20px; font-weight: 700; margin-bottom: 30px; color: #333;">Gift Card Message</h2>

        <div class="gift-layout" style="display: flex; gap: 40px; align-items: flex-start;">
            <!-- 왼쪽: 옵션 -->
            <div class="gift-options" style="flex: 1;">
                <h4 style="font-size: 16px; margin-bottom: 15px;">• 편지 문구 추천</h4>
                <div class="btn-group">
                    <button class="selection-btn active" onclick="toggleGiftMessage(this)">✓ 짧은 문구</button>
                    <button class="selection-btn" onclick="toggleGiftMessage(this)">긴 문구</button>
                </div>
            </div>

            <!-- 오른쪽: 카드 미리보기 -->
            <div class="gift-preview-area" style="flex: 2; position: relative;">
                <div class="card-box" id="card-content" style="background: #fdfaf6; padding: 30px; border-radius: 15px; border: 1px solid #e0d5c5; min-height: 120px; line-height: 1.8; color: #5d554a; font-style: italic;">
                    "너의 분위기를 닮은 향, 선물할게."<br>
                    "첫 만남이 더 기억나면 좋겠어서."<br>
                    "말보다 향이 먼저 마음을 전해줄 수 있으니까."
                </div>
                <span class="material-icons refresh-icon" style="position: absolute; bottom: 10px; right: 10px; color: #9c8cc1; cursor: pointer;">cached</span>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // 1. [코디 이미지] 로드
    fetch('/api/user-outfit/')
        .then(res => res.json())
        .then(data => {
            const outfitArea = document.getElementById('outfit-display-area');
            if (!outfitArea) return;
            outfitArea.innerHTML = '';
            if (data.onepiece_img) {
                outfitArea.innerHTML = `<img src="${data.onepiece_img}" class="outfit-card onepiece-card">`;
            } else if (data.top_img && data.bottom_img) {
                outfitArea.innerHTML = `
                    <img src="${data.top_img}" class="outfit-card top-card">
                    <img src="${data.bottom_img}" class="outfit-card bottom-card">
                `;
            } else {
                outfitArea.innerHTML = `<span class="material-icons" style="font-size: 60px; color: #ddd;">checkroom</span>`;
            }
        });

    // 2. [향수 정보 및 이미지] 로드
    fetch('/api/perfume-top3-images/')
        .then(res => res.json())
        .then(data => {
            const container = document.getElementById('perfume-results-container');
            if (!container) return;
            container.innerHTML = '';

            if (data.length === 0) {
                container.innerHTML = "<p style='text-align:center; width:100%; color:#999;'>추천된 향수가 없습니다.</p>";
                return;
            }

            data.forEach((item) => {
                const accordText = item.accords.join(' · ');
                const formattedScore = parseFloat(item.myscore).toFixed(2);
                const pId = item.perfume_id;

                const cardHtml = `
                    <div class="perfume-card">
                        <div class="perfume-img-slot">
                            <img src="${item.image_url}" style="width:100%; height:100%; object-fit:contain;" onerror="this.src='/static/ui/images/default_perfume.png'">
                        </div>
                        <div class="perfume-details">
                            <h4 class="p-name">${item.perfume_name}</h4>
                            <p class="p-brand">${item.brand}</p>
                            <p class="p-info-tags">${item.gender}</p>
                            <p class="p-accords-list">${accordText}</p>
                            <div class="score-display-row">
                                <span class="score-label">Matching Score</span>
                                <span class="score-value">${formattedScore}</span>
                                <span class="score-max">/ 3</span>
                            </div>
                            <div class="feedback-container" id="feedback-area-${pId}">
                                <p class="feedback-msg">추천이 만족스러우신가요?</p>
                                <div class="feedback-btns">
                                    <button class="f-btn like" onclick="handleLike(${pId})"><span class="material-icons">thumb_up</span></button>
                                    <button class="f-btn dislike" onclick="toggleTagBox(${pId})"><span class="material-icons">thumb_down</span></button>
                                </div>
                                <div class="tag-selection-box" id="tag-box-${pId}" style="display:none;">
                                    <div class="tag-chips">
                                        <span class="t-chip" onclick="this.classList.toggle('active')">코디와 안 어울림</span>
                                        <span class="t-chip" onclick="this.classList.toggle('active')">계절감 불일치</span>
                                    </div>
                                    <button class="t-submit-btn" onclick="submitFeedback(${pId})">의견 보내기</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', cardHtml);
            });
        });

    // 3. [AI 요약] 로드
    fetch('/api/someone-summary/')
        .then(res => res.json())
        .then(data => {
            const summaryBox = document.getElementById('ai-summary-text');
            if (summaryBox && data.summary) {
                summaryBox.innerHTML = data.summary.replace(/\n/g, '<br>');
            }
        });
});

// Gift Card 전용 로직
function toggleGiftMessage(element) {
    const parent = element.parentElement;
    const siblings = parent.getElementsByClassName('selection-btn');
    for (let btn of siblings) {
        btn.classList.remove('active');
        btn.innerText = btn.innerText.replace('✓ ', '');
    }
    element.classList.add('active');
    element.innerText = '✓ ' + element.innerText;

    const cardBox = document.getElementById('card-content');
    if (element.innerText.includes('짧은')) {
        cardBox.innerHTML = `"너의 분위기를 닮은 향, 선물할게."<br>"첫 만남이 더 기억나면 좋겠어서."<br>"말보다 향이 먼저 마음을 전해줄 수 있으니까."`;
    } else {
        cardBox.innerHTML = `"평소 너의 이미지와 잘 어울릴 것 같아서 골랐어.<br>이 향기가 너의 하루를 더 특별하게 만들어주길 바라.<br>오늘도 좋은 하루 보내!"<br><br>"지나가다 우연히 맡은 향이 너랑 너무 찰떡이라<br>그냥 지나칠 수가 없더라. 부담 갖지 말고 편하게 써줘!"`;
    }
}

// 피드백 관련 함수
function toggleTagBox(pId) {
    const box = document.getElementById(`tag-box-${pId}`);
    if (box) box.style.display = box.style.display === 'none' ? 'block' : 'none';
}
function handleLike(pId) {
    alert("피드백 감사합니다!");
    document.getElementById(`feedback-area-${pId}`).innerHTML = "<p class='thanks-msg'>피드백이 반영되었습니다! ✨</p>";
}
function submitFeedback(pId) {
    alert("소중한 의견 감사합니다!");
    document.getElementById(`feedback-area-${pId}`).innerHTML = "<p class='thanks-msg'>피드백이 반영되었습니다! ✨</p>";
}
</script>
{% endblock %}