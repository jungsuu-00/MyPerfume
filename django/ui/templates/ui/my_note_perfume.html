{% extends 'ui/base.html' %}
{% load static %}
{% block content %}

<div class="form-container">

  <!-- ========================= -->
  <!-- í—¤ë” -->
  <!-- ========================= -->
  <div class="header">
    <h1>MyNote</h1>
    <p>í–¥ìˆ˜ë¥¼ ê²€ìƒ‰í•˜ê³  ì ìˆ˜ë¥¼ ê¸°ë¡í•´ë³´ì„¸ìš”</p>
  </div>

  <!-- ========================= -->
  <!-- 4-1 ì„ íƒ ìš”ì•½ (ì½ê¸° ì „ìš©) -->
  <!-- ========================= -->
  <div class="section content-align">
    <span class="box-label">ì„ íƒí•œ ìŠ¤íƒ€ì¼</span>

    <div class="summary-box">
      <p>ğŸ‘— ì„ íƒí•œ ì˜·ê³¼ ê³„ì ˆì„ ê¸°ì¤€ìœ¼ë¡œ í–¥ìˆ˜ë¥¼ ê¸°ë¡í•©ë‹ˆë‹¤.</p>
      <p style="color:#888; font-size:13px;">
        (ì´ ì •ë³´ëŠ” 4-1ì—ì„œ ì„ íƒí•œ ë‚´ìš©ì…ë‹ˆë‹¤)
      </p>
    </div>
  </div>

  <!-- ========================= -->
  <!-- í–¥ìˆ˜ ê²€ìƒ‰ -->
  <!-- ========================= -->
  <div class="section content-align">
    <span class="box-label">í–¥ìˆ˜ ê²€ìƒ‰</span>

    <div class="search-row">
      <input
        type="text"
        id="perfume-search-input"
        placeholder="í–¥ìˆ˜ ì´ë¦„ì´ë‚˜ ë¸Œëœë“œë¥¼ ê²€ìƒ‰í•˜ì„¸ìš”"
        class="text-input"
      >
      <button class="selection-btn" onclick="searchPerfume()">ê²€ìƒ‰</button>
    </div>

    <!-- ê²€ìƒ‰ ê²°ê³¼ -->
    <div id="search-result" class="card-grid">
      <!-- JSë¡œ ë™ì  ë Œë” -->
    </div>
  </div>

  <!-- ========================= -->
  <!-- MyNote ì¥ë°”êµ¬ë‹ˆ -->
  <!-- ========================= -->
  <div class="section content-align">
    <span class="box-label">MyNote</span>

    <div id="cart-list" class="cart-list">
      <p style="color:#aaa;">ì•„ì§ ì €ì¥ëœ í–¥ìˆ˜ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
    </div>
  </div>

  <!-- ========================= -->
  <!-- ì™„ë£Œ -->
  <!-- ========================= -->
  <div class="submit-container">
    <button class="submit-btn" onclick="completeMyNote()">ì™„ë£Œ</button>
  </div>

</div>

<!-- ========================= -->
<!-- JS (UI ì „ìš© / API ì—°ê²° ì „) -->
<!-- ========================= -->
<script>
const csrfToken = '{{ csrf_token }}';

function searchPerfume() {
  const keyword = document.getElementById("perfume-search-input").value.trim();
  const resultBox = document.getElementById("search-result");

  if (!keyword) {
    alert("ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
    return;
  }

  fetch(`/api/my-note/perfume/search/?q=${encodeURIComponent(keyword)}`)
    .then(res => res.json())
    .then(data => {
      resultBox.innerHTML = "";

      if (data.length === 0) {
        resultBox.innerHTML = "<p style='color:#aaa;'>ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>";
        return;
      }

      data.forEach(p => {
        resultBox.innerHTML += `
          <div class="card">
            <img src="${p.perfume_img_url}" class="card-img">
            <div class="card-info">
              <strong>${p.name}</strong>
              <p>${p.brand}</p>

              <input
                type="number"
                min="0"
                max="100"
                placeholder="ì ìˆ˜"
                class="score-input"
                id="score-${p.perfume_id}"
              >

              <button class="selection-btn"
                onclick="addToCart(
                ${p.perfume_id},
                '${p.name}',
                '${p.brand}',
                '${p.perfume_img_url}'
                )">
                ì €ì¥
              </button>
            </div>
          </div>
        `;
      });
    })
    .catch(() => {
      alert("í–¥ìˆ˜ ê²€ìƒ‰ ì‹¤íŒ¨");
    });
}


/* ì¥ë°”êµ¬ë‹ˆ ì¶”ê°€ */
function addToCart(id, name, brand, img) {
  const scoreInput = document.getElementById(`score-${id}`);
  const score = scoreInput.value;

  if (!score) {
    alert("ì ìˆ˜ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
    return;
  }

  fetch('/api/my-note/perfume/cart/', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': csrfToken
    },
    body: JSON.stringify({
      perfume_id: id,
      perfume_name: name,
      brand: brand,
      perfume_img_url: img,
      smelling_rate: score
    })


  })
  .then(res => res.json())
  .then(data => {
    renderCart(data.data);   // ì´ê²Œ í•µì‹¬
  })
  .catch(() => {
    alert("ì¥ë°”êµ¬ë‹ˆ ì €ì¥ ì‹¤íŒ¨");
  });
}


/* ì¥ë°”êµ¬ë‹ˆ ë Œë” */
function renderCart(cart) {
  const cartBox = document.getElementById('cart-list');

  if (!cart || cart.length === 0) {
    cartBox.innerHTML = `<p style="color:#aaa;">ì•„ì§ ì €ì¥ëœ í–¥ìˆ˜ê°€ ì—†ìŠµë‹ˆë‹¤.</p>`;
    return;
  }

  cartBox.innerHTML = "";

  cart.forEach(p => {
    cartBox.innerHTML += `
      <div class="cart-item">
        <img src="${p.perfume_img_url}" class="cart-img">
        <div class="cart-info">
            <strong>${p.perfume_name}</strong>
            <p>${p.brand}</p>
          <span>ì ìˆ˜: ${p.smelling_rate}</span>
        </div>
        <button class="delete-btn" onclick="removeFromCart(${p.perfume_id})">ì‚­ì œ</button>
      </div>
    `;
  });
}

/* ì¥ë°”êµ¬ë‹ˆ ì‚­ì œ */
function removeFromCart(perfumeId) {
  fetch('/api/my-note/perfume/cart/', {
    method: 'DELETE',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': csrfToken
    },
    body: JSON.stringify({
      perfume_id: perfumeId
    })
  })
  .then(res => res.json())
  .then(data => {
    renderCart(data.data);
  });
}


/* ì™„ë£Œ (DB ì €ì¥ â†’ ê²°ê³¼ í˜ì´ì§€ ì´ë™) */
function completeMyNote() {
  fetch("/api/my-note/perfume/complete/", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "X-CSRFToken": csrfToken
    }
  })
  .then(res => {
    if (!res.ok) throw new Error();
    return res.json();
  })
  .then(() => {
    window.location.href = "/my-note/result/";
  })
  .catch(() => {
    alert("ìµœì†Œ í•œ ê°œì˜ í–¥ìˆ˜ë¥¼ ì €ì¥í•´ì£¼ì„¸ìš”.");
  });
}


</script>
{% endblock %}